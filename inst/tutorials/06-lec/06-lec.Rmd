---
title: "Developing your own Stan models"
output: 
  learnr::tutorial:
    progressive: true
    allow_skip: true
    css: css/learnr-theme.css
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
## --- learnr ---
if ("learnr" %in% (.packages()))
  detach(package:learnr, unload = TRUE)
library(learnr)
knitr::opts_chunk$set(echo = FALSE)

## ---- CRAN Packages ----
## Save package names as a vector of strings
pkgs <-  c("rstan", "rstantools", "coda", "dplyr")

## Install uninstalled packages
lapply(pkgs[!(pkgs %in% installed.packages())], 
       install.packages,
       repos='http://cran.us.r-project.org')

## Load all packages to library and adjust options
lapply(pkgs, library, character.only = TRUE)

## ---- Global learnr Objects ----

## ---- export function ----
export <- function(env = environment()) {
  invisible({
    global_obj <- eval(global_objects, envir = globalenv())
    local_obj <- ls(envir = env)
    new_obj <- local_obj[!(local_obj %in% global_obj)]
    sapply(new_obj, function(x) {
      assign(x, get(eval(x, envir = env), envir = env), envir = globalenv())
    })
  })
  if (!is.null(new_obj)){
    print("Exported objects:")
    print(new_obj)
  }
}
global_objects <- c(ls(), "global_objects")

## ---- rstan Options ----
rstan_options(auto_write = TRUE)             # avoid recompilation of models
options(mc.cores = parallel::detectCores())  # parallelize across all CPUs
```


## Some ideas

### Relaxing model assumptions

- You estimate a hierarchical GLM with random intercepts and few groups.
- Reviewer 2 has read up on some recent publications (e.g., [Stegmueller 2013](https://onlinelibrary.wiley.com/doi/full/10.1111/ajps.12001); [Elff et al. 2020](https://www.elff.eu/article/multilevel-improving/)) and criticizes your use of normally distributed random effects.
- Why not use Stan to relax this distributional assumption?
- You may, e.g., reestimate your model with different distributions for your random effects, and conduct simulation studies to test their relative performance towards one another.

### Heterogeneous treatment effects

- You conduct an RCT with a binary treatment on political attitudes.
- You use a standard difference-in-means estimator, which yields a null effect.
- This is in line with your expectations, as you expect that the treatment will "shift" some individuals to the left, others to the right.
- You cannot accurately characterize left-shifters an right-shifters in terms of covariates and, therefore, not present meaningful subgroup-specific difference-in-means estimates.
- Why not focus on the variance, then?
- Use Stan to implement a "difference-in-variances" estimator. Use the posterior distribution for inference on the question if your treatment polarizes political attitudes among treated individuals relative to control units.

### Re-running (and extending) models written in defunct or proprietary programming languages

- In *When Moderate Voters Prefer Extreme Parties*, [Kedar (2005)](https://www.cambridge.org/core/journals/american-political-science-review/article/when-moderate-voters-prefer-extreme-parties-policy-balancingin-parliamentary-elections/A6729F56D47DDD3993DD3CA02840B6B0) proposes a formal model for representational (sincere) and compensational (strategic) voting.
- The model involves a mixing parameter, $\beta$: $$u_{ij} = \theta [-\beta \times \text{representational}_{ij} - (1 - \beta) \times \text{compensational}_{ij}] + \mathbf{z}_{i}^{\prime}\delta_j $$
- The empirical analyses implement this idea in a conditional logit model with a constrained mixing parameter, $\beta \in [0,1]$, and coded up in [GAUSS](https://en.wikipedia.org/wiki/GAUSS_(software)).
- Why not implement this model in Stan?
- Why not transfer the idea of a mixing parameter to a different type of model?
- Why not extend the idea of a mixing parameter from two to three (or more) components, and allow it to vary? One example: A trivariate heterogeneous mixing parameter that tests how consistently policy distances on (1) socio-economic issues, (2) immigration, and (3) climate change affect vote choices for voters of different generations?

### An example from my own research: Modeling comparative vote switching

```{r france, exercise = FALSE, echo = FALSE, out.width = '90%', fig.align="center"}
knitr::include_graphics("files/fr17-plots-1.png")
```

### Voter transition matrices

<table class="huxtable" style="border-collapse: collapse; border: 0px; margin-bottom: 2em; margin-top: 2em; ; margin-left: auto; margin-right: auto;  " id="tab:transition-matrix-6">
<caption style="caption-side: bottom; text-align: center;">Voter transition matrix, UK General Elections 2005-2010.</caption><col><col><col><col><col><col><col><tr>
<th style="vertical-align: top; text-align: left; white-space: normal; border-style: solid solid solid solid; border-width: 0pt 0pt 0.4pt 0pt;    padding: 0pt 4pt 4pt 0pt; background-color: rgb(242, 242, 242); font-weight: bold; font-size: 9pt;"></th><th style="vertical-align: top; text-align: center; white-space: normal; border-style: solid solid solid solid; border-width: 0pt 0pt 0.4pt 0pt;    padding: 0pt 4pt 4pt 4pt; background-color: rgb(242, 242, 242); font-weight: bold; font-size: 9pt;">LAB '10</th><th style="vertical-align: top; text-align: center; white-space: normal; border-style: solid solid solid solid; border-width: 0pt 0pt 0.4pt 0pt;    padding: 0pt 4pt 4pt 4pt; background-color: rgb(242, 242, 242); font-weight: bold; font-size: 9pt;">LIB '10</th><th style="vertical-align: top; text-align: center; white-space: normal; border-style: solid solid solid solid; border-width: 0pt 0pt 0.4pt 0pt;    padding: 0pt 4pt 4pt 4pt; background-color: rgb(242, 242, 242); font-weight: bold; font-size: 9pt;">CON '10</th><th style="vertical-align: top; text-align: center; white-space: normal; border-style: solid solid solid solid; border-width: 0pt 0pt 0.4pt 0pt;    padding: 0pt 4pt 4pt 4pt; background-color: rgb(242, 242, 242); font-weight: bold; font-size: 9pt;">OTH '10</th><th style="vertical-align: top; text-align: center; white-space: normal; border-style: solid solid solid solid; border-width: 0pt 0pt 0.4pt 0pt;    padding: 0pt 4pt 4pt 4pt; background-color: rgb(242, 242, 242); font-weight: bold; font-size: 9pt;">NON '10</th><th style="vertical-align: top; text-align: center; white-space: normal; border-style: solid solid solid solid; border-width: 0pt 0pt 0.4pt 0pt;    padding: 0pt 0pt 4pt 4pt; background-color: rgb(242, 242, 242); font-weight: bold; font-size: 9pt;">2005</th></tr>
<tr>
<td style="vertical-align: top; text-align: left; white-space: normal; border-style: solid solid solid solid; border-width: 0.4pt 0pt 0pt 0pt;    padding: 4pt 4pt 4pt 0pt; background-color: rgb(242, 242, 242); font-weight: bold; font-size: 9pt;">LAB '05</td><td style="vertical-align: top; text-align: center; white-space: normal; border-style: solid solid solid solid; border-width: 0.4pt 0pt 0pt 0pt;    padding: 4pt 4pt 4pt 4pt; background-color: rgb(242, 242, 242); font-weight: normal; font-size: 9pt;"> 12.7</td><td style="vertical-align: top; text-align: center; white-space: normal; border-style: solid solid solid solid; border-width: 0.4pt 0pt 0pt 0pt;    padding: 4pt 4pt 4pt 4pt; font-weight: normal; font-size: 9pt;">  2.3</td><td style="vertical-align: top; text-align: center; white-space: normal; border-style: solid solid solid solid; border-width: 0.4pt 0pt 0pt 0pt;    padding: 4pt 4pt 4pt 4pt; font-weight: normal; font-size: 9pt;">  2.1</td><td style="vertical-align: top; text-align: center; white-space: normal; border-style: solid solid solid solid; border-width: 0.4pt 0pt 0pt 0pt;    padding: 4pt 4pt 4pt 4pt; font-weight: normal; font-size: 9pt;">  0.7</td><td style="vertical-align: top; text-align: center; white-space: normal; border-style: solid solid solid solid; border-width: 0.4pt 0pt 0pt 0pt;    padding: 4pt 4pt 4pt 4pt; font-weight: normal; font-size: 9pt;">  3.8</td><td style="vertical-align: top; text-align: center; white-space: normal; border-style: solid solid solid solid; border-width: 0.4pt 0pt 0pt 0pt;    padding: 4pt 0pt 4pt 4pt; background-color: rgb(242, 242, 242); font-weight: bold; font-size: 9pt;"> 21.6</td></tr>
<tr>
<td style="vertical-align: top; text-align: left; white-space: normal; padding: 4pt 4pt 4pt 0pt; background-color: rgb(242, 242, 242); font-weight: bold; font-size: 9pt;">LIB '05</td><td style="vertical-align: top; text-align: center; white-space: normal; padding: 4pt 4pt 4pt 4pt; font-weight: normal; font-size: 9pt;">  1.4</td><td style="vertical-align: top; text-align: center; white-space: normal; padding: 4pt 4pt 4pt 4pt; background-color: rgb(242, 242, 242); font-weight: normal; font-size: 9pt;">  8.7</td><td style="vertical-align: top; text-align: center; white-space: normal; padding: 4pt 4pt 4pt 4pt; font-weight: normal; font-size: 9pt;">  1.7</td><td style="vertical-align: top; text-align: center; white-space: normal; padding: 4pt 4pt 4pt 4pt; font-weight: normal; font-size: 9pt;">  0.4</td><td style="vertical-align: top; text-align: center; white-space: normal; padding: 4pt 4pt 4pt 4pt; font-weight: normal; font-size: 9pt;">  1.2</td><td style="vertical-align: top; text-align: center; white-space: normal; padding: 4pt 0pt 4pt 4pt; background-color: rgb(242, 242, 242); font-weight: bold; font-size: 9pt;"> 13.5</td></tr>
<tr>
<td style="vertical-align: top; text-align: left; white-space: normal; padding: 4pt 4pt 4pt 0pt; background-color: rgb(242, 242, 242); font-weight: bold; font-size: 9pt;">CON '05</td><td style="vertical-align: top; text-align: center; white-space: normal; padding: 4pt 4pt 4pt 4pt; font-weight: normal; font-size: 9pt;">  0.8</td><td style="vertical-align: top; text-align: center; white-space: normal; padding: 4pt 4pt 4pt 4pt; font-weight: normal; font-size: 9pt;">  1.0</td><td style="vertical-align: top; text-align: center; white-space: normal; padding: 4pt 4pt 4pt 4pt; background-color: rgb(242, 242, 242); font-weight: normal; font-size: 9pt;"> 15.0</td><td style="vertical-align: top; text-align: center; white-space: normal; padding: 4pt 4pt 4pt 4pt; font-weight: normal; font-size: 9pt;">  1.0</td><td style="vertical-align: top; text-align: center; white-space: normal; padding: 4pt 4pt 4pt 4pt; font-weight: normal; font-size: 9pt;">  2.0</td><td style="vertical-align: top; text-align: center; white-space: normal; padding: 4pt 0pt 4pt 4pt; background-color: rgb(242, 242, 242); font-weight: bold; font-size: 9pt;"> 19.9</td></tr>
<tr>
<td style="vertical-align: top; text-align: left; white-space: normal; padding: 4pt 4pt 4pt 0pt; background-color: rgb(242, 242, 242); font-weight: bold; font-size: 9pt;">OTH '05</td><td style="vertical-align: top; text-align: center; white-space: normal; padding: 4pt 4pt 4pt 4pt; font-weight: normal; font-size: 9pt;">  0.2</td><td style="vertical-align: top; text-align: center; white-space: normal; padding: 4pt 4pt 4pt 4pt; font-weight: normal; font-size: 9pt;">  0.7</td><td style="vertical-align: top; text-align: center; white-space: normal; padding: 4pt 4pt 4pt 4pt; font-weight: normal; font-size: 9pt;">  0.6</td><td style="vertical-align: top; text-align: center; white-space: normal; padding: 4pt 4pt 4pt 4pt; background-color: rgb(242, 242, 242); font-weight: normal; font-size: 9pt;">  3.5</td><td style="vertical-align: top; text-align: center; white-space: normal; padding: 4pt 4pt 4pt 4pt; font-weight: normal; font-size: 9pt;">  1.3</td><td style="vertical-align: top; text-align: center; white-space: normal; padding: 4pt 0pt 4pt 4pt; background-color: rgb(242, 242, 242); font-weight: bold; font-size: 9pt;">  6.4</td></tr>
<tr>
<td style="vertical-align: top; text-align: left; white-space: normal; border-style: solid solid solid solid; border-width: 0pt 0pt 0.4pt 0pt;    padding: 4pt 4pt 4pt 0pt; background-color: rgb(242, 242, 242); font-weight: bold; font-size: 9pt;">NON '05</td><td style="vertical-align: top; text-align: center; white-space: normal; border-style: solid solid solid solid; border-width: 0pt 0pt 0.4pt 0pt;    padding: 4pt 4pt 4pt 4pt; font-weight: normal; font-size: 9pt;">  3.7</td><td style="vertical-align: top; text-align: center; white-space: normal; border-style: solid solid solid solid; border-width: 0pt 0pt 0.4pt 0pt;    padding: 4pt 4pt 4pt 4pt; font-weight: normal; font-size: 9pt;">  2.2</td><td style="vertical-align: top; text-align: center; white-space: normal; border-style: solid solid solid solid; border-width: 0pt 0pt 0.4pt 0pt;    padding: 4pt 4pt 4pt 4pt; font-weight: normal; font-size: 9pt;">  4.0</td><td style="vertical-align: top; text-align: center; white-space: normal; border-style: solid solid solid solid; border-width: 0pt 0pt 0.4pt 0pt;    padding: 4pt 4pt 4pt 4pt; font-weight: normal; font-size: 9pt;">  2.2</td><td style="vertical-align: top; text-align: center; white-space: normal; border-style: solid solid solid solid; border-width: 0pt 0pt 0.4pt 0pt;    padding: 4pt 4pt 4pt 4pt; background-color: rgb(242, 242, 242); font-weight: normal; font-size: 9pt;"> 26.5</td><td style="vertical-align: top; text-align: center; white-space: normal; border-style: solid solid solid solid; border-width: 0pt 0pt 0.4pt 0pt;    padding: 4pt 0pt 4pt 4pt; background-color: rgb(242, 242, 242); font-weight: bold; font-size: 9pt;"> 38.6</td></tr>
<tr>
<td style="vertical-align: top; text-align: left; white-space: normal; border-style: solid solid solid solid; border-width: 0.4pt 0pt 0pt 0pt;    padding: 4pt 4pt 0pt 0pt; background-color: rgb(242, 242, 242); font-weight: bold; font-size: 9pt;">2010</td><td style="vertical-align: top; text-align: center; white-space: normal; border-style: solid solid solid solid; border-width: 0.4pt 0pt 0pt 0pt;    padding: 4pt 4pt 0pt 4pt; background-color: rgb(242, 242, 242); font-weight: bold; font-size: 9pt;"> 18.9</td><td style="vertical-align: top; text-align: center; white-space: normal; border-style: solid solid solid solid; border-width: 0.4pt 0pt 0pt 0pt;    padding: 4pt 4pt 0pt 4pt; background-color: rgb(242, 242, 242); font-weight: bold; font-size: 9pt;"> 15.0</td><td style="vertical-align: top; text-align: center; white-space: normal; border-style: solid solid solid solid; border-width: 0.4pt 0pt 0pt 0pt;    padding: 4pt 4pt 0pt 4pt; background-color: rgb(242, 242, 242); font-weight: bold; font-size: 9pt;"> 23.5</td><td style="vertical-align: top; text-align: center; white-space: normal; border-style: solid solid solid solid; border-width: 0.4pt 0pt 0pt 0pt;    padding: 4pt 4pt 0pt 4pt; background-color: rgb(242, 242, 242); font-weight: bold; font-size: 9pt;">  7.7</td><td style="vertical-align: top; text-align: center; white-space: normal; border-style: solid solid solid solid; border-width: 0.4pt 0pt 0pt 0pt;    padding: 4pt 4pt 0pt 4pt; background-color: rgb(242, 242, 242); font-weight: bold; font-size: 9pt;"> 34.9</td><td style="vertical-align: top; text-align: center; white-space: normal; border-style: solid solid solid solid; border-width: 0.4pt 0pt 0pt 0pt;    padding: 4pt 0pt 0pt 4pt; background-color: rgb(242, 242, 242); font-weight: bold; font-size: 9pt;">100.0</td></tr>
</table>

#### Basic quantities of interest

1. .cyan[Party-specific retention rates], $p_{i,i}$
2. .cyan[Dyadic gross gains/losses], $p_{i,j}$
3. .cyan[Dyadic trade volumes], $V_{i,j} = p_{j,i} + p_{i,j}$
4. .cyan[Dyadic trade balances], $V_{i,j} = p_{j,i} - p_{i,j}$
  
#### Derived quantities of interest: Aggregate and normalize as needed

Let our quantity of interest be .cyan[government parties'] trade balances with .cyan[opposition parties], .cyan[relative to their own support base at t - 1]:

$$\text{QOI} = \frac{100 \times \sum_{j = 2}^{4} p_{j, 1} -  p_{1, j}}{\sum_{k = 1}^{5} p_{1, k}} = \frac{100 \times (2.6 - 5.2)}{21.6} \approx 12.0$$

### Mixed Aggregate MNL Model with Varying Choice Sets (MAVCL)

#### Description

MAVCL models latent election-level .cyan[cell proportions], $\Pr(y_{j} = c)$, derived as average micro-level .cyan[choice probabilities], based on cell counts, $w_{jc}$:

- A categorical likelihood at the voter level models individual *choice probabilities* (as in MNL).
- As the model only involves election-level covariates, we can re-express this model at the election-level with $w_{jc}$'s serve as election-and-cell-specific frequency weights. This yields a multinomial quasi-likelihood at the election-level.
- Here, election-cell-specific random effects capture variation of interest: Latent election-specific *cell proportions*.
- Party system heterogeneity yields election-specific choice sets $S_j = \{1,...,C\}$
  + some outcomes categories $c$ will be deterministically empty
  + accommodated in a modified softmax link function (see Yamamoto 2014)


#### Formal notation

- Linear component: $\eta_{jc} = \alpha_c + \mathbf{x}_j^{\prime} \beta_c + \nu_{jc} \text{  for each  } c \in S_{j}$
- Link function: $\Pr(y_{j} = c | \mathbf{x}_j) = \frac{\exp(\eta_{jc})}{\sum_{c \in S_{j}} \exp(\eta_{jc})}$
- Likelihood: $\log L = \sum_{j=1}^{J} \sum_{c \in S_{j}} w_{jc} \log \Pr(y_{j} = c | \mathbf{x}_j)$

### Software implementation

<p align="center">
  <iframe width="800" height="520" src="files/voteswitchR-package.html" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</p>

